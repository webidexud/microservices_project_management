<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modificaciones del Proyecto - PMO System</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <style>
        .comparativo-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .comparativo-card {
            background: white;
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
        }

        .comparativo-label {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: var(--space-2);
        }

        .comparativo-value {
            font-size: var(--font-2xl);
            font-weight: 700;
            color: var(--text-dark);
        }

        .comparativo-value.modificado {
            color: var(--primary-color);
        }

        .comparativo-value.tachado {
            text-decoration: line-through;
            color: var(--text-tertiary);
            font-size: var(--font-lg);
        }

        .modificacion-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
            border-left: 4px solid;
        }

        .modificacion-card.adicion {
            border-left-color: #10b981;
        }

        .modificacion-card.prorroga {
            border-left-color: #3b82f6;
        }

        .modificacion-card.adicion-prorroga {
            border-left-color: #f59e0b;
        }

        .modificacion-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: var(--space-4);
        }

        .modificacion-tipo {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .modificacion-tipo.adicion {
            background: var(--success-bg);
            color: var(--success-color);
        }

        .modificacion-tipo.prorroga {
            background: var(--info-bg);
            color: var(--info-color);
        }

        .modificacion-tipo.adicion-prorroga {
            background: var(--warning-bg);
            color: var(--warning-color);
        }

        .modificacion-detalle {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .detalle-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .detalle-label {
            font-size: var(--font-xs);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .detalle-value {
            font-size: var(--font-base);
            color: var(--text-dark);
            font-weight: 500;
        }

        .alert-info {
            background: var(--primary-light);
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
            color: var(--primary-color);
            font-size: var(--font-sm);
            display: flex;
            align-items: start;
            gap: var(--space-3);
        }

        .tipo-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .tipo-option {
            padding: var(--space-4);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-fast);
        }

        .tipo-option:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .tipo-option.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .tipo-option-icon {
            font-size: 32px;
            margin-bottom: var(--space-2);
        }

        .tipo-option-label {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--text-dark);
        }

        @media (max-width: 768px) {
            .comparativo-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-brand-icon">‚úì</div>
                <div class="sidebar-brand-text">PMO System</div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-menu-item" onclick="window.location.href='../index.html'">
                        <span class="sidebar-menu-icon">üè†</span>
                        <span class="sidebar-menu-text">Inicio</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Gesti√≥n</div>
                    <div class="sidebar-menu-item" onclick="window.location.href='listar-proyectos.html'">
                        <span class="sidebar-menu-icon">üìÅ</span>
                        <span class="sidebar-menu-text">Proyectos</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- HEADER -->
            <header class="app-header">
                <div class="header-left">
                    <h1 class="header-title">Modificaciones del Proyecto</h1>
                </div>
                
                <div class="header-right">
                    <button class="header-icon-btn">üîç</button>
                    <button class="header-icon-btn">üîî</button>
                    <div class="header-user">
                        <div class="header-user-avatar">U</div>
                    </div>
                </div>
            </header>

            <!-- PAGE CONTENT -->
            <main class="page-content">
                <a href="javascript:history.back()" class="back-button" style="display: inline-flex; align-items: center; gap: 8px; color: var(--text-secondary); margin-bottom: var(--space-5);">
                    ‚Üê Volver
                </a>

                <!-- INFORMACI√ìN DEL PROYECTO -->
                <div id="proyectoInfo" class="card" style="margin-bottom: var(--space-6);"></div>

                <!-- COMPARATIVO -->
                <div class="comparativo-container" id="comparativoContainer"></div>

                <!-- BOT√ìN NUEVA MODIFICACI√ìN -->
                <div style="margin-bottom: var(--space-6);">
                    <button class="btn btn-primary" onclick="mostrarFormulario()">
                        ‚ûï Nueva Modificaci√≥n
                    </button>
                </div>

                <!-- FORMULARIO (Oculto por defecto) -->
                <div id="formularioContainer" style="display: none; margin-bottom: var(--space-6);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìù Nueva Modificaci√≥n</h3>
                        </div>
                        <div class="card-body">
                            <form id="formularioModificacion">
                                <!-- Selector de Tipo -->
                                <div class="form-group full">
                                    <label class="form-label">Tipo de Modificaci√≥n <span class="required">*</span></label>
                                    <div class="tipo-selector">
                                        <div class="tipo-option selected" onclick="seleccionarTipo('ADICION')" data-tipo="ADICION">
                                            <div class="tipo-option-icon">üí∞</div>
                                            <div class="tipo-option-label">Adici√≥n</div>
                                            <div style="font-size: var(--font-xs); color: var(--text-secondary); margin-top: var(--space-1);">
                                                Aumento de valor
                                            </div>
                                        </div>
                                        <div class="tipo-option" onclick="seleccionarTipo('PRORROGA')" data-tipo="PRORROGA">
                                            <div class="tipo-option-icon">‚è±Ô∏è</div>
                                            <div class="tipo-option-label">Pr√≥rroga</div>
                                            <div style="font-size: var(--font-xs); color: var(--text-secondary); margin-top: var(--space-1);">
                                                Aumento de tiempo
                                            </div>
                                        </div>
                                        <div class="tipo-option" onclick="seleccionarTipo('ADICION_PRORROGA')" data-tipo="ADICION_PRORROGA">
                                            <div class="tipo-option-icon">üìä</div>
                                            <div class="tipo-option-label">Ambas</div>
                                            <div style="font-size: var(--font-xs); color: var(--text-secondary); margin-top: var(--space-1);">
                                                Valor y tiempo
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="tipo" name="tipo" value="ADICION" required>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">N√∫mero de Modificaci√≥n <span class="required">*</span></label>
                                        <input type="number" id="numero_modificacion" name="numero_modificacion" class="form-input" required readonly style="background: var(--bg-tertiary);">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Fecha de Modificaci√≥n <span class="required">*</span></label>
                                        <input type="date" id="fecha_modificacion" name="fecha_modificacion" class="form-input" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Acto Administrativo</label>
                                    <input type="text" id="acto_administrativo" name="acto_administrativo" class="form-input" placeholder="Ej: Resoluci√≥n 123 de 2024">
                                </div>

                                <!-- Campos para ADICI√ìN -->
                                <div id="camposAdicion">
                                    <div class="form-group">
                                        <label class="form-label">Valor de la Adici√≥n (COP) <span class="required">*</span></label>
                                        <input type="text" id="valor_adicion" name="valor_adicion" class="form-input" placeholder="5000000">
                                    </div>
                                </div>

                                <!-- Campos para PR√ìRROGA -->
                                <div id="camposProrroga" style="display: none;">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">D√≠as de Pr√≥rroga <span class="required">*</span></label>
                                            <input type="number" id="dias_prorroga" name="dias_prorroga" class="form-input" placeholder="30" min="1">
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Nueva Fecha de Finalizaci√≥n</label>
                                            <input type="date" id="nueva_fecha_fin" name="nueva_fecha_fin" class="form-input" readonly style="background: var(--bg-tertiary);">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Observaciones</label>
                                    <textarea id="observaciones" name="observaciones" class="form-textarea" placeholder="Descripci√≥n de la modificaci√≥n..." rows="3"></textarea>
                                </div>

                                <div style="display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-6);">
                                    <button type="button" class="btn btn-secondary" onclick="ocultarFormulario()">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        ‚úì Guardar Modificaci√≥n
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- HISTORIAL -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Historial de Modificaciones</h3>
                    </div>
                    <div class="card-body">
                        <div id="historialModificaciones"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/proyectos.js"></script>
    <script src="../js/modificaciones.js"></script>
    <script>
        let proyectoActual = null;
        let tipoSeleccionado = 'ADICION';

        // Obtener ID del proyecto de la URL
        function obtenerProyectoId() {
            const params = new URLSearchParams(window.location.search);
            return parseInt(params.get('id'));
        }

        // Cargar informaci√≥n del proyecto
        function cargarProyecto() {
            const proyectoId = obtenerProyectoId();
            if (!proyectoId) {
                alert('No se especific√≥ un proyecto v√°lido');
                window.location.href = 'listar-proyectos.html';
                return;
            }

            proyectoActual = obtenerProyectoPorId(proyectoId);
            if (!proyectoActual) {
                alert('Proyecto no encontrado');
                window.location.href = 'listar-proyectos.html';
                return;
            }

            renderizarInfoProyecto();
            renderizarComparativo();
            renderizarHistorial();
            
            // Configurar n√∫mero de modificaci√≥n
            const modificaciones = obtenerModificaciones(proyectoId);
            document.getElementById('numero_modificacion').value = modificaciones.length + 1;
            
            // Configurar fecha actual
            document.getElementById('fecha_modificacion').value = new Date().toISOString().split('T')[0];
        }

        // Renderizar informaci√≥n del proyecto
        function renderizarInfoProyecto() {
            const html = `
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <div class="badge badge-primary" style="margin-bottom: var(--space-2);">
                                Proyecto #${proyectoActual.proyecto_id}
                            </div>
                            <h2 style="font-size: var(--font-2xl); margin-bottom: var(--space-2);">
                                ${proyectoActual.nombre_proyecto}
                            </h2>
                            <p style="color: var(--text-secondary); font-size: var(--font-sm);">
                                A√±o ${proyectoActual.anio_proyecto}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('proyectoInfo').innerHTML = html;
        }

        // Renderizar comparativo
        function renderizarComparativo() {
            const totales = calcularTotalesConModificaciones(
                proyectoActual.proyecto_id,
                proyectoActual.valor_proyecto,
                proyectoActual.fecha_finalizacion
            );

            const valorInicial = parseFloat(proyectoActual.valor_proyecto);
            const tieneModificaciones = totales.numeroModificaciones > 0;

            const html = `
                <div class="comparativo-card">
                    <div class="comparativo-label">üí∞ Valor Inicial</div>
                    <div class="comparativo-value ${tieneModificaciones ? 'tachado' : ''}">
                        ${formatearMoneda(valorInicial)}
                    </div>
                    ${tieneModificaciones ? `
                        <div style="margin-top: var(--space-2); font-size: var(--font-sm); color: var(--success-color);">
                            + ${formatearMoneda(totales.totalAdiciones)} en adiciones
                        </div>
                    ` : ''}
                </div>

                <div class="comparativo-card">
                    <div class="comparativo-label">üìä Valor Total</div>
                    <div class="comparativo-value modificado">
                        ${formatearMoneda(totales.valorTotal)}
                    </div>
                    ${tieneModificaciones ? `
                        <div style="margin-top: var(--space-2); font-size: var(--font-sm); color: var(--text-secondary);">
                            ${totales.numeroModificaciones} modificaci√≥n(es)
                        </div>
                    ` : ''}
                </div>

                <div class="comparativo-card">
                    <div class="comparativo-label">üìÖ Plazo</div>
                    <div class="comparativo-value ${totales.diasProrrogaTotal > 0 ? 'tachado' : ''}">
                        ${formatearFecha(proyectoActual.fecha_finalizacion)}
                    </div>
                    ${totales.diasProrrogaTotal > 0 ? `
                        <div style="margin-top: var(--space-3);">
                            <div class="comparativo-value modificado" style="font-size: var(--font-lg);">
                                ${formatearFecha(totales.fechaFinActual)}
                            </div>
                            <div style="margin-top: var(--space-2); font-size: var(--font-sm); color: var(--info-color);">
                                + ${totales.diasProrrogaTotal} d√≠as de pr√≥rroga
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('comparativoContainer').innerHTML = html;
        }

        // Renderizar historial
        function renderizarHistorial() {
            const modificaciones = obtenerModificaciones(proyectoActual.proyecto_id);
            
            if (modificaciones.length === 0) {
                document.getElementById('historialModificaciones').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-title">No hay modificaciones</div>
                        <div class="empty-state-description">
                            Las modificaciones al proyecto aparecer√°n aqu√≠
                        </div>
                    </div>
                `;
                return;
            }

            const html = modificaciones.map((mod, index) => {
                const tipoClass = mod.tipo.toLowerCase().replace('_', '-');
                const tipoTexto = {
                    'ADICION': 'üí∞ Adici√≥n',
                    'PRORROGA': '‚è±Ô∏è Pr√≥rroga',
                    'ADICION_PRORROGA': 'üìä Adici√≥n y Pr√≥rroga'
                }[mod.tipo];

                return `
                    <div class="modificacion-card ${tipoClass}">
                        <div class="modificacion-header">
                            <div>
                                <span class="modificacion-tipo ${tipoClass}">${tipoTexto}</span>
                                <div style="margin-top: var(--space-3); font-size: var(--font-lg); font-weight: 600;">
                                    Modificaci√≥n #${mod.numero_modificacion}
                                </div>
                            </div>
                            <div style="text-align: right; color: var(--text-secondary); font-size: var(--font-sm);">
                                ${formatearFecha(mod.fecha_modificacion)}
                            </div>
                        </div>

                        <div class="modificacion-detalle">
                            ${(mod.tipo === 'ADICION' || mod.tipo === 'ADICION_PRORROGA') ? `
                                <div class="detalle-item">
                                    <div class="detalle-label">Valor Adici√≥n</div>
                                    <div class="detalle-value" style="color: var(--success-color); font-weight: 700;">
                                        ${formatearMoneda(mod.valor_adicion)}
                                    </div>
                                </div>
                            ` : ''}

                            ${(mod.tipo === 'PRORROGA' || mod.tipo === 'ADICION_PRORROGA') ? `
                                <div class="detalle-item">
                                    <div class="detalle-label">D√≠as Pr√≥rroga</div>
                                    <div class="detalle-value" style="color: var(--info-color); font-weight: 700;">
                                        ${mod.dias_prorroga} d√≠as
                                    </div>
                                </div>
                                <div class="detalle-item">
                                    <div class="detalle-label">Nueva Fecha Fin</div>
                                    <div class="detalle-value">
                                        ${formatearFecha(mod.nueva_fecha_fin)}
                                    </div>
                                </div>
                            ` : ''}

                            ${mod.acto_administrativo ? `
                                <div class="detalle-item">
                                    <div class="detalle-label">Acto Administrativo</div>
                                    <div class="detalle-value">${mod.acto_administrativo}</div>
                                </div>
                            ` : ''}
                        </div>

                        ${mod.observaciones ? `
                            <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-light);">
                                <div class="detalle-label">Observaciones</div>
                                <div class="detalle-value">${mod.observaciones}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            document.getElementById('historialModificaciones').innerHTML = html;
        }

        // Mostrar/Ocultar formulario
        function mostrarFormulario() {
            document.getElementById('formularioContainer').style.display = 'block';
            document.getElementById('formularioContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function ocultarFormulario() {
            document.getElementById('formularioContainer').style.display = 'none';
            document.getElementById('formularioModificacion').reset();
        }

        // Seleccionar tipo de modificaci√≥n
        function seleccionarTipo(tipo) {
            tipoSeleccionado = tipo;
            document.getElementById('tipo').value = tipo;

            // Actualizar estilos visuales
            document.querySelectorAll('.tipo-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.tipo === tipo) {
                    option.classList.add('selected');
                }
            });

            // Mostrar/ocultar campos seg√∫n el tipo
            const camposAdicion = document.getElementById('camposAdicion');
            const camposProrroga = document.getElementById('camposProrroga');
            const inputValorAdicion = document.getElementById('valor_adicion');
            const inputDiasProrroga = document.getElementById('dias_prorroga');

            if (tipo === 'ADICION') {
                camposAdicion.style.display = 'block';
                camposProrroga.style.display = 'none';
                inputValorAdicion.required = true;
                inputDiasProrroga.required = false;
            } else if (tipo === 'PRORROGA') {
                camposAdicion.style.display = 'none';
                camposProrroga.style.display = 'block';
                inputValorAdicion.required = false;
                inputDiasProrroga.required = true;
            } else if (tipo === 'ADICION_PRORROGA') {
                camposAdicion.style.display = 'block';
                camposProrroga.style.display = 'block';
                inputValorAdicion.required = true;
                inputDiasProrroga.required = true;
            }
        }

        // Calcular nueva fecha al cambiar d√≠as de pr√≥rroga
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dias_prorroga')?.addEventListener('input', function() {
                const dias = parseInt(this.value) || 0;
                if (dias > 0 && proyectoActual) {
                    const totales = calcularTotalesConModificaciones(
                        proyectoActual.proyecto_id,
                        proyectoActual.valor_proyecto,
                        proyectoActual.fecha_finalizacion
                    );
                    
                    const fechaBase = new Date(totales.fechaFinActual);
                    fechaBase.setDate(fechaBase.getDate() + dias);
                    
                    document.getElementById('nueva_fecha_fin').value = fechaBase.toISOString().split('T')[0];
                }
            });
        });

        // Aplicar formato a valor de adici√≥n
        setupFormatoEconomico('valor_adicion');

        // Manejar env√≠o del formulario
        document.getElementById('formularioModificacion').addEventListener('submit', function(e) {
            e.preventDefault();

            try {
                const formData = new FormData(this);
                const datos = {
                    tipo: tipoSeleccionado,
                    numero_modificacion: parseInt(formData.get('numero_modificacion')),
                    fecha_modificacion: formData.get('fecha_modificacion'),
                    acto_administrativo: formData.get('acto_administrativo'),
                    observaciones: formData.get('observaciones'),
                    usuario: 'Usuario Demo'
                };

                // Agregar campos seg√∫n el tipo
                if (tipoSeleccionado === 'ADICION' || tipoSeleccionado === 'ADICION_PRORROGA') {
                    datos.valor_adicion = limpiarNumero(formData.get('valor_adicion'));
                }

                if (tipoSeleccionado === 'PRORROGA' || tipoSeleccionado === 'ADICION_PRORROGA') {
                    datos.dias_prorroga = parseInt(formData.get('dias_prorroga'));
                    datos.nueva_fecha_fin = formData.get('nueva_fecha_fin');
                }

                // Validar
                validarModificacion(
                    datos.tipo,
                    datos.valor_adicion,
                    datos.dias_prorroga
                );

                // Guardar
                guardarModificacion(proyectoActual.proyecto_id, datos);

                // Actualizar proyecto en localStorage
                const proyectos = obtenerProyectos();
                const indice = proyectos.findIndex(p => p.proyecto_id === proyectoActual.proyecto_id);
                
                if (indice !== -1) {
                    if (datos.valor_adicion) {
                        const valorActual = parseFloat(proyectos[indice].valor_proyecto) || 0;
                        proyectos[indice].valor_proyecto = valorActual + datos.valor_adicion;
                    }
                    if (datos.nueva_fecha_fin) {
                        proyectos[indice].fecha_finalizacion = datos.nueva_fecha_fin;
                    }
                    guardarProyectos(proyectos);
                }

                // Recargar todo
                cargarProyecto();
                ocultarFormulario();
                
                mostrarNotificacion('‚úì Modificaci√≥n registrada correctamente', 'success');

            } catch (error) {
                mostrarNotificacion('‚ùå ' + error.message, 'error');
            }
        });

        // Inicializar
        cargarProyecto();
    </script>
</body>
</html>